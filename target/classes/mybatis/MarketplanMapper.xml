<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace必须指向Dao接口 -->
<mapper namespace="com.palm.lingcai.repository.MarketplanDao">

    <resultMap id="resultMap" type="com.palm.lingcai.entity.Marketplan">
        <result property="id" column="id"/>
        <result property="marketName" column="marketName"/>
        <result property="marketDesc" column="marketDesc"/>
        <result property="userId" column="userId"/>
        <result property="startTime" column="startTime"/>
        <result property="endTime" column="endTime"/>
        <result property="unitPrice" column="unitPrice"/>
        <result property="frequency" column="frequency"/>
        <result property="totalPrice" column="totalPrice"/>
        <result property="otherReward" column="otherReward"/>
        <result property="marketType" column="marketType"/>
        <result property="status" column="status"/>
        <result property="payFlag" column="payFlag"/>
        <result property="auditFlag" column="auditFlag"/>
        <result property="createTime" column="createTime"/>
        <result property="modifyTime" column="modifyTime"/>
        <result property="content" column="content"/>
        <result property="shortUrl" column="shortUrl"/>
        <result property="sender" column="sender"/>
        <result property="lotteryType" column="lotteryType"/>
        <result property="lotteryName" column="lotteryName"/>
        <result property="consumerAmount" column="consumerAmount"/>
        <result property="channel" column="channel"/>
        <result property="balanceFixed" column="balanceFixed"/>
        <result property="ruleid" column="ruleid"/>
        <result property="remark" column="remark"/>
        <result property="pubFlags" column="pubFlags"/>
        <result property="posterPath" column="posterPath"/>
        <result property="marketAppKey" column="market_app_key"/>
        <result property="marketAppSecret" column="market_app_secret"/>
    </resultMap>

    <!-- 用于select查询公用抽取的列 -->
    <sql id="columns">
		id,marketName,marketDesc,userId,startTime,endTime,unitPrice,frequency,totalPrice,otherReward,marketType,status,payFlag,auditFlag,createTime,modifyTime,lotteryType,lotteryName,balanceFixed,ruleid,remark,pubFlags,posterPath
		,market_app_key,market_app_secret
	</sql>

    <!-- 获取用户: 输出直接映射到对象 -->
    <select id="get" parameterType="Long" resultType="Marketplan">
        SELECT
        <include refid="columns"/>
        FROM tab_marketplan
        WHERE id=#{id}
    </select>

    <!--根据短网址获取对象-->
    <select id="getByShorturl" parameterType="String" resultType="Marketplan">
        SELECT
        <include refid="columns"/>
        FROM tab_marketplan
        WHERE shorturl=#{shorturl}
    </select>

    <!-- 获取当前正在执行的计划 -->
    <select id="findExecutePlan" resultMap="resultMap">
		SELECT * FROM tab_marketplan
		WHERE
			<![CDATA[
	        date(startTime) <= date(now()) and date(endTime) >= date(now())
	        ]]>
	        <if test="userid != null and userid != ''">
				AND userid=#{userid}
	        </if>
    </select>
    
    <!-- 获取审核通过且在时间范围内的计划 -->
    <select id="findApproveMarketplan" resultMap="resultMap">
        SELECT * FROM tab_marketplan
		WHERE
			<![CDATA[
	        date(startTime) <= date(now()) and date(endTime) >= date(now())
	        ]]>
	        <if test="searchParams.status != null and searchParams.status != ''">
				AND status=#{searchParams.status}
	        </if>
    </select>

    <!-- 根据用户统计所有营销计划产生的用户总数 -->
    <select id="countByUser" parameterType="Long" resultType="int">
		SELECT count(distinct userid) FROM tab_user_lottery
		WHERE
        <![CDATA[
        marketid in (select id from tab_marketplan where userid=#{userid})

        ]]>
    </select>

    <!-- 查询需要返款的计划 -->
	<select id="marketplanRefund" parameterType="map" resultMap="resultMap">
	    select 
	    <include refid="columns"/>
	    from tab_marketplan
	    where status=5 and date(now())>date(endTime)
	</select>
    
    <!-- 查询用户, 不分页 -->
    <select id="search" parameterType="map" resultMap="resultMap">
        SELECT
        <include refid="columns"/>
        FROM tab_marketplan
        <where>
            <if test="marketName != null and marketName != ''">
                AND marketName = #{marketName}
            </if>
            <if test="marketDesc != null and marketDesc != ''">
                AND marketDesc = #{marketDesc}
            </if>
            <if test="userId != null and userId != ''">
                AND userId = #{userId}
            </if>
            <if test="startTime != null and startTime != ''">
                AND startTime = #{startTime}
            </if>
            <if test="endTime != null and endTime != ''">
                AND endTime = #{endTime}
            </if>
            <if test="unitPrice != null and unitPrice != ''">
                AND unitPrice = #{unitPrice}
            </if>
            <if test="frequency != null and frequency != ''">
                AND frequency = #{frequency}
            </if>
            <if test="totalPrice != null and totalPrice != ''">
                AND totalPrice = #{totalPrice}
            </if>
            <if test="otherReward != null and otherReward != ''">
                AND otherReward = #{otherReward}
            </if>
            <if test="marketType != null and marketType != ''">
                AND marketType = #{marketType}
            </if>
            <if test="status != null ">
                AND status = #{status}
            </if>
            <if test="payFlag != null">
                AND payFlag = #{payFlag}
            </if>
            <if test="auditFlag != null and auditFlag != ''">
                AND auditFlag = #{auditFlag}
            </if>
            <if test="createTime != null and createTime != ''">
                AND createTime = #{createTime}
            </if>
            <if test="modifyTime != null and modifyTime != ''">
                AND modifyTime = #{modifyTime}
            </if>
            <if test="lotteryType != null and lotteryType != ''">
                AND lotteryType = #{lotteryType}
            </if>
            <if test="lotteryName != null and lotteryName != ''">
                AND lotteryName = #{lotteryName}
            </if>
            <if test="balanceFixed != null">
                AND balanceFixed = #{balanceFixed}
            </if>
        </where>
        <if test="sortColumns != null and sortColumns != ''">
            ORDER BY ${searchFields.sortColumns}
        </if>
    </select>

    <!-- 分页查询 -->
    <select id="searchPage" resultMap="resultMap">
        SELECT
        <include refid="columns"/>
        FROM tab_marketplan
        <where>
            <if test="searchFields.marketName != null and searchFields.marketName != ''">
                AND marketName like CONCAT(CONCAT('%', #{searchFields.marketName}), '%')
            </if>
            <if test="searchFields.marketDesc != null and searchFields.marketDesc != ''">
                AND marketDesc = #{searchFields.marketDesc}
            </if>
            <if test="searchFields.userId != null and searchFields.userId != ''">
                AND userId = #{searchFields.userId}
            </if>
            <if test="searchFields.startTime != null and searchFields.startTime != ''">
                <![CDATA[AND startTime >= #{searchFields.startTime}]]>
            </if>
            <if test="searchFields.endTime != null and searchFields.endTime != ''">
                <![CDATA[ AND endTime <= #{searchFields.endTime}]]>
            </if>
            <if test="searchFields.unitPrice != null and searchFields.unitPrice != ''">
                AND unitPrice = #{searchFields.unitPrice}
            </if>
            <if test="searchFields.frequency != null and searchFields.frequency != ''">
                AND frequency = #{searchFields.frequency}
            </if>
            <if test="searchFields.totalPrice != null and searchFields.totalPrice != ''">
                AND totalPrice = #{searchFields.totalPrice}
            </if>
            <if test="searchFields.otherReward != null and searchFields.otherReward != ''">
                AND otherReward = #{searchFields.otherReward}
            </if>
            <if test="searchFields.marketType != null and searchFields.marketType != ''">
                AND marketType = #{searchFields.marketType}
            </if>
            <if test="searchFields.status != null and searchFields.status != ''">
                AND status in (${searchFields.status})
            </if>
            <if test="searchFields.payFlag != null and searchFields.payFlag != ''">
                AND payFlag in (${searchFields.payFlag})
            </if>
            <if test="searchFields.auditFlag != null and searchFields.auditFlag != ''">
                AND auditFlag = #{searchFields.auditFlag}
            </if>
            <if test="searchFields.createTime != null and searchFields.createTime != ''">
                AND createTime = #{searchFields.createTime}
            </if>
            <if test="searchFields.modifyTime != null and searchFields.modifyTime != ''">
                AND modifyTime = #{searchFields.modifyTime}
            </if>
            <if test="searchFields.lotteryType != null and searchFields.lotteryType != ''">
                AND lotteryType = #{searchFields.lotteryType}
            </if>
            <if test="searchFields.lotteryName != null and searchFields.lotteryName != ''">
                AND lotteryName = #{searchFields.lotteryName}
            </if>
            <if test="searchFields.balanceFixed != null">
                AND balanceFixed = #{searchFields.balanceFixed}
            </if>
            and status != 7
        </where>
        <if test="searchFields.sortColumns != null and searchFields.sortColumns != ''">
            ORDER BY ${searchFields.sortColumns}
        </if>
    </select>


    <!-- 查询支付宝直接支付计划已消费列表 -->
    <select id="searchFundsDetailList" resultMap="resultMap">
        select sum(a.money) as consumerAmount,b.*,c.channel from tab_user_lottery a,tab_marketplan b,tab_recharge c
        <where>
        a.marketid = b.id and b.id=c.marketplanId and c.billstatus = 1 and b.status=6 and b.balanceFixed = 1
        <if test="userid != null">
            AND b.userId = #{userid}
        </if>
        <if test="channel != null">
            AND c.channel = #{channel}
        </if>
        </where>
        group by a.marketid having <![CDATA[consumerAmount < b.totalPrice]]> order by b.userId
    </select>

    <!-- 新增 -->
    <insert id="addMarketingPlan" parameterType="Marketplan" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO tab_marketplan (
        	marketName,
        	marketDesc,
        	userId,
        	startTime,
        	endTime,
        	unitPrice,
        	frequency,
        	totalPrice,
        	otherReward,
        	marketType,
        	status,
        	payFlag,
        	auditFlag,
        	createTime,
        	modifyTime,
        	lotteryType,
        	lotteryName,
        	balanceFixed,
        	remark,
        	pubFlags,
        	posterPath
		) VALUES (
        	#{marketName},
        	#{marketDesc},
        	#{userId},
        	#{startTime},
        	#{endTime},
        	#{unitPrice},
        	#{frequency},
        	#{totalPrice},
        	#{otherReward},
        	#{marketType},
        	#{status},
        	#{payFlag},
        	#{auditFlag},
        	#{createTime},
        	#{modifyTime},
        	#{lotteryType},
        	#{lotteryName},
        	#{balanceFixed},
        	#{remark},
        	#{pubFlags},
        	#{posterPath}
		)
	</insert>

    <!-- 更新 -->
    <update id="update" >
        UPDATE tab_marketplan
        <set>
            <if test="marketName != null">
                marketName = #{marketName},
            </if>
            <if test="marketDesc != null">
                marketDesc = #{marketDesc},
            </if>
            <if test="userId != null">
                userId = #{userId},
            </if>
            <if test="startTime != null">
                startTime = #{startTime},
            </if>
            <if test="endTime != null">
                endTime = #{endTime},
            </if>
            <if test="unitPrice != null">
                unitPrice = #{unitPrice},
            </if>
            <if test="frequency != null">
                frequency = #{frequency},
            </if>
            <if test="totalPrice != null">
                totalPrice = #{totalPrice},
            </if>
            <if test="otherReward != null">
                otherReward = #{otherReward},
            </if>
            <if test="marketType != null">
                marketType = #{marketType},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="payFlag != null">
                payFlag = #{payFlag},
            </if>
            <if test="auditFlag != null">
                auditFlag = #{auditFlag},
            </if>
            <if test="createTime != null">
                createTime = #{createTime},
            </if>
            <if test="modifyTime != null">
                modifyTime = #{modifyTime},
            </if>
            <if test="lotteryType != null">
                lotteryType = #{lotteryType},
            </if>
            <if test="lotteryName != null">
                lotteryName = #{lotteryName},
            </if>
            <if test="balanceFixed != null">
                balanceFixed = #{balanceFixed},
            </if>
            <if test="remark != null">
                remark = #{remark},
            </if>
            <if test="pubFlags != null">
                pubFlags = #{pubFlags}
            </if>
            <if test="posterPath != null">
                posterPath = #{posterPath}
            </if>
        </set>
        WHERE
        id = #{id}
    </update>

    <!-- 删除用户 -->
    <delete id="delete" parameterType="Long">
	     DELETE FROM tab_marketplan WHERE id=#{id}
	</delete>

    <select id="findMarketplanByMarketNameAndUserId" parameterType="map" resultMap="resultMap">
        SELECT
        <include refid="columns"/>
        FROM tab_marketplan
        <where>
            AND marketName = #{marketName}
            AND userId = #{userId}
        </where>
    </select>

    <select id="findMarketplanByMarketIdAndUserId" parameterType="map" resultMap="resultMap">
        SELECT
        <include refid="columns"/>
        FROM tab_marketplan
        <where>
            AND id = #{marketplanId}
            AND userId = #{userId}
        </where>
    </select>

    <select id="searchForMessageByUserid" parameterType="Long" resultMap="resultMap">
        select a.* ,b.content as content, b.sender as sender 
        from tab_marketplan a,tab_message b 
        where a.id=b.marketid and a.userId=#{userid} order by a.id DESC
    </select>

    <!-- 删除用户 -->
    <delete id="deleteByIdAndUser">
	     DELETE FROM tab_marketplan WHERE id=#{id} and userId=#{userId}
	</delete>

	<!-- 获取活动时间已结束的计划 -->
    <select id="findEndMakretplan" resultMap="resultMap">
		SELECT * FROM tab_marketplan
		WHERE
        <![CDATA[
        date(endTime) <= date(now()) and status != 6
        ]]>
    </select>
    <!-- 获取marketplanKey查询计划 -->
    <select id="getByMarketplanKey" resultType="Marketplan">
		SELECT * FROM tab_marketplan
		WHERE market_app_key =  #{marketAppKey} limit 1
    </select>

	<!-- 更新营销余额 -->
	<update id="updateMarketBanlance">
		UPDATE tab_marketplan
		<set>
			totalPrice = totalPrice+#{money}
		</set>
		WHERE id = #{id}
	</update>
</mapper> 
