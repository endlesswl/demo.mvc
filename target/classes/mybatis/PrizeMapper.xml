<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace必须指向Dao接口 -->
<mapper namespace="com.palm.lingcai.repository.PrizeDao">

    <resultMap id="resultMap" type="com.palm.lingcai.entity.Prize">
        <result property="id" column="id"/>
        <result property="gametype" column="gametype"/>
        <result property="gameid" column="gameid"/>
        <result property="issueNo" column="issueNo"/>
        <result property="orderid" column="orderid"/>
        <result property="palmid" column="palmid"/>
        <result property="prizetime" column="prizetime"/>
        <result property="prizeball" column="prizeball"/>
        <result property="prizeStatus" column="prizeStatus"/>
        <result property="prizeMoney" column="prizeMoney"/>
        <result property="prizeLevel" column="prizeLevel"/>
        <result property="prizeMoneyAfterTax" column="prizeMoneyAfterTax"/>
        <result property="tax" column="tax"/>
        <result property="createtime" column="createtime"/>
        <result property="prizefile" column="prizefile"/>
        <result property="remark" column="remark"/>
    </resultMap>

    <!-- 用于select查询公用抽取的列 -->
    <sql id="columns">
		id,gametype,gameid,issueNo,orderid,palmid,prizetime,prizeball,prizeStatus,prizeMoney,prizeLevel,prizeMoneyAfterTax,tax,createtime,prizefile,remark
	</sql>

    <!-- 根据彩票期号查询开奖信息 -->
    <select id="getPrizeballByIssueNo" resultType="Prize">
        SELECT *
		FROM tab_prize
		<where>
			<if test="issueNo != null and issueNo != ''">
                AND issueNo = #{issueNo}
            </if>
            AND orderid =''
		</where>
    </select>
    
    <!-- 获取对象: 输出直接映射到对象 -->
    <select id="get" parameterType="Long" resultType="Prize">
		SELECT *
		FROM tab_prize
		WHERE id=#{id}
	</select>

    <!-- 根据彩种获得当前需要查询的开奖公告 -->
    <select id="searchByWaitPrize" resultMap="resultMap">
        SELECT *
        FROM tab_prize
        <where>
            now() > str_to_date(prizetime,'%Y%m%d%H%i%s') AND prizefile = ''
        </where>
    </select>

    <!-- 获取对象: 输出直接映射到对象 -->
    <select id="getByGameidAndIssueNo" resultType="Prize">
		SELECT *
		FROM tab_prize
		WHERE issueNo=#{issueNo} and gameid=#{gameid} limit 1
	</select>

    <!-- 根据订单id查询中奖详情 -->
    <select id="searchByOrderId" resultType="Prize">
        SELECT *
		FROM tab_prize
		WHERE orderid=#{orderid}
    </select>
    
    <!-- 查询列表, 不分页 -->
    <select id="search" parameterType="map" resultMap="resultMap">
        SELECT
        <include refid="columns"/>
        FROM tab_prize
        <where>
            <if test="gameid != null and gameid != ''">
                AND gameid = #{gameid}
            </if>
            <if test="gametype != null and gametype != ''">
                AND gametype = #{gametype}
            </if>
            <if test="issueNo != null and issueNo != ''">
                AND issueNo = #{issueNo}
            </if>
            <if test="orderid != null and orderid != ''">
                AND orderid = #{orderid}
            </if>
            <if test="palmid != null and palmid != ''">
                AND palmid = #{palmid}
            </if>
            <if test="prizetime != null and prizetime != ''">
                AND prizetime = #{prizetime}
            </if>
            <if test="prizeball != null and prizeball != ''">
                AND prizeball = #{prizeball}
            </if>
            <if test="prizeStatus != null and prizeStatus != ''">
                AND prizeStatus = #{prizeStatus}
            </if>
            <if test="prizeMoney != null and prizeMoney != ''">
                AND prizeMoney = #{prizeMoney}
            </if>
            <if test="prizeLevel != null and prizeLevel != ''">
                AND prizeLevel = #{prizeLevel}
            </if>
            <if test="prizeMoneyAfterTax != null and prizeMoneyAfterTax != ''">
                AND prizeMoneyAfterTax = #{prizeMoneyAfterTax}
            </if>
            <if test="tax != null and tax != ''">
                AND tax = #{tax}
            </if>
            <if test="createtime != null and createtime != ''">
                AND createtime = #{createtime}
            </if>
            <if test="prizefile != null and prizefile != ''">
                AND prizefile = #{prizefile}
            </if>
            <if test="remark != null and remark != ''">
                AND remark = #{remark}
            </if>
        </where>
        <if test="sortColumns != null and sortColumns != ''">
            ORDER BY ${sortColumns}
        </if>
    </select>

    <!-- 分页查询 -->
    <select id="searchPage" resultMap="resultMap">
        SELECT
        <include refid="columns"/>
        FROM tab_prize
        <where>
            <if test="searchFields.gameid != null and searchFields.gameid != ''">
                AND gameid = #{searchFields.gameid}
            </if>
            <if test="searchFields.gametype != null and searchFields.gametype != ''">
                AND gametype = #{searchFields.gametype}
            </if>
            <if test="searchFields.issueNo != null and searchFields.issueNo != ''">
                AND issueNo = #{searchFields.issueNo}
            </if>
            <if test="searchFields.orderid != null and searchFields.orderid != ''">
                AND orderid = #{searchFields.orderid}
            </if>
            <if test="searchFields.palmid != null and searchFields.palmid != ''">
                AND palmid = #{searchFields.palmid}
            </if>
            <if test="searchFields.prizetime != null and searchFields.prizetime != ''">
                AND prizetime = #{searchFields.prizetime}
            </if>
            <if test="searchFields.prizeball != null and searchFields.prizeball != ''">
                AND prizeball = #{searchFields.prizeball}
            </if>
            <if test="searchFields.prizeStatus != null and searchFields.prizeStatus != ''">
                AND prizeStatus = #{searchFields.prizeStatus}
            </if>
            <if test="searchFields.prizeMoney != null and searchFields.prizeMoney != ''">
                AND prizeMoney = #{searchFields.prizeMoney}
            </if>
            <if test="searchFields.prizeLevel != null and searchFields.prizeLevel != ''">
                AND prizeLevel = #{searchFields.prizeLevel}
            </if>
            <if test="searchFields.prizeMoneyAfterTax != null and searchFields.prizeMoneyAfterTax != ''">
                AND prizeMoneyAfterTax = #{searchFields.prizeMoneyAfterTax}
            </if>
            <if test="searchFields.tax != null and searchFields.tax != ''">
                AND tax = #{searchFields.tax}
            </if>
            <if test="searchFields.createtime != null and searchFields.createtime != ''">
                AND createtime = #{searchFields.createtime}
            </if>
            <if test="searchFields.prizefile != null and searchFields.prizefile != ''">
                AND prizefile = #{searchFields.prizefile}
            </if>
            <if test="searchFields.remark != null and searchFields.remark != ''">
                AND remark = #{searchFields.remark}
            </if>
        </where>
        <if test="searchFields.sortColumns != null and searchFields.sortColumns != ''">
            ORDER BY ${searchFields.sortColumns}
        </if>
    </select>

    <!-- 新增 -->
    <insert id="insert" parameterType="Prize" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO tab_prize (
        	gameid,
        	gametype,
        	issueNo,
        	orderid,
        	palmid,
        	prizetime,
        	prizeball,
        	prizeStatus,
        	prizeMoney,
        	prizeLevel,
        	prizeMoneyAfterTax,
        	tax,
        	createtime,
        	prizefile,
        	remark
		) VALUES (
        	#{gameid},
        	#{gametype},
        	#{issueNo},
        	#{orderid},
        	#{palmid},
        	#{prizetime},
        	#{prizeball},
        	#{prizeStatus},
        	#{prizeMoney},
        	#{prizeLevel},
        	#{prizeMoneyAfterTax},
        	#{tax},
        	#{createtime},
        	#{prizefile},
        	#{remark}
		)
	</insert>

    <!-- 更新 -->
    <update id="update">
        UPDATE tab_prize
        <set>
            <if test="gameid != null">
                gameid = #{gameid},
            </if>
            <if test="gametype != null">
                gametype = #{gametype},
            </if>
            <if test="issueNo != null">
                issueNo = #{issueNo},
            </if>
            <if test="orderid != null">
                orderid = #{orderid},
            </if>
            <if test="palmid != null">
                palmid = #{palmid},
            </if>
            <if test="prizetime != null">
                prizetime = #{prizetime},
            </if>
            <if test="prizeball != null">
                prizeball = #{prizeball},
            </if>
            <if test="prizeStatus != null">
                prizeStatus = #{prizeStatus},
            </if>
            <if test="prizeMoney != null">
                prizeMoney = #{prizeMoney},
            </if>
            <if test="prizeLevel != null">
                prizeLevel = #{prizeLevel},
            </if>
            <if test="prizeMoneyAfterTax != null">
                prizeMoneyAfterTax = #{prizeMoneyAfterTax},
            </if>
            <if test="tax != null">
                tax = #{tax},
            </if>
            <if test="createtime != null">
                createtime = #{createtime},
            </if>
            <if test="prizefile != null">
                prizefile = #{prizefile},
            </if>
            <if test="remark != null">
                remark = #{remark}
            </if>
        </set>
        WHERE
        id = #{id}
    </update>

    <!-- 删除用户 -->
    <delete id="delete" parameterType="Long">
	     DELETE FROM tab_prize WHERE id=#{id}
	</delete>
	
    <!-- 中奖总金额 -->
    <select id="countPrizeSumMoney" resultType="BigDecimal">
        select sum(prizeMoney) from tab_prize tp,tab_lottery tl
        <where>
            <if test="marketid != null and marketid != ''">
                AND tl.marketid=#{marketid}
            </if>
            <if test="issueNo != null and issueNo != ''">
                AND tp.issueNo=#{issueNo}
            </if>
        </where>
          and tl.orderid=tp.orderid
    </select>
    
    <!-- 各级中奖详情 -->
    <select id="countPrizeInfo" resultType="int">
        SELECT count(*) from tab_prize tp,tab_lottery tl
        <where>
            <if test="marketid != null and marketid != ''">
                AND tl.marketid=#{marketid}
            </if>
            <if test="issueNo != null and issueNo != ''">
                AND tp.issueNo=#{issueNo}
            </if>
            <if test="prizeMoney != null and prizeMoney != ''">
                AND tp.prizeMoney=#{prizeMoney}
            </if>
        </where>
        and tp.prizeStatus=2 and tl.orderid=tp.orderid
    </select>
    
    
    <!-- 获取最近中奖号码 -->
    <select id="getLatestPrizeBall" resultMap="resultMap">
       	SELECT *
        FROM tab_prize t
        where 1=1
       	<![CDATA[ AND t.prizeball <>'' ]]>
        <if test="gameId != null and gameId != ''">
				AND t.gameid = #{gameId}
		</if>
        ORDER BY t.issueNo DESC LIMIT 1
    </select>
</mapper> 
