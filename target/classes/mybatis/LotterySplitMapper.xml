<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace必须指向Dao接口 -->
<mapper namespace="com.palm.lingcai.repository.LotterySplitDao">

    <resultMap id="resultMap" type="com.palm.lingcai.entity.LotterySplit">
        <result property="id" column="id"/>
        <result property="userid" column="userid"/>
        <result property="updatetime" column="updatetime"/>
        <result property="createtime" column="createtime"/>
        <result property="remainderCount" column="remainderCount"/>
        <result property="remainderPercent" column="remainderPercent"/>
        <result property="isTuhao" column="isTuhao"/>
        <result property="lotteryid" column="lotteryid"/>
        <result property="lotteryids" column="lotteryids"/>
        <result property="totalCount" column="totalCount"/>
        <result property="marketid" column="marketid"/>
        <result property="isprize" column="isprize"/>
        <result property="gameid" column="gameid"/>
        <result property="username" column="username"/>
        <result property="count" column="count"/>
    </resultMap>

    <!-- 用于select查询公用抽取的列 -->
    <sql id="columns">
		id,userid,updatetime,createtime,remainderCount,remainderPercent,isTuhao,lotteryid,lotteryids,totalCount,marketid
	</sql>

    <!-- 查询乐享榜 -->
    <select id="findErrorSplit" resultMap="resultMap">
        SELECT
        <include refid="columns"/>
        FROM tab_lottery_split ss WHERE ss.id IN ( 16, 17, 18, 20, 21, 24, 25, 28, 30, 32, 34, 35, 37, 38, 39, 40, 44,
        48, 49, 51, 52, 54, 55, 61, 65, 67, 75, 76, 77, 78, 80, 81, 86, 88, 89, 90, 92, 95, 96, 97, 101, 103, 105, 107,
        108, 109, 111, 113, 115, 117, 121, 123, 125, 127, 131, 132, 133, 137, 138, 143, 144, 145, 146, 150, 151, 152,
        153, 156, 158, 159, 160, 161, 162, 163, 165, 166, 171, 173, 175, 176, 179, 180, 181, 183, 184, 185, 186, 189,
        192, 195, 198, 199, 204, 206, 221, 222, 225, 230, 232, 233, 234, 240, 241, 247, 248, 249, 250, 252, 253, 255,
        257, 264, 267, 268, 270, 275, 279, 282, 283, 284, 289, 290, 292, 296, 298, 300, 306, 307, 308, 309, 310, 311,
        315, 317, 318, 325, 327, 332, 333, 334, 336, 338, 339, 340, 341, 346, 347, 349, 350, 351, 352, 354, 355, 358,
        360, 363, 368, 369, 372, 375, 376, 377, 378, 380, 383, 384, 385, 386, 387, 388, 391, 393, 395, 396, 398, 399,
        400, 403, 406, 407, 408, 409, 410, 418, 419, 422, 423, 424, 430, 431, 432, 437, 442, 444, 446, 448, 451, 456,
        457, 458, 461, 462, 464, 469, 470, 473, 475, 480, 481, 483, 487, 490, 492, 497, 498, 500, 506, 507, 510, 512,
        513, 517, 519, 520, 521, 532, 534, 538, 541, 544, 549, 550, 551, 557, 561, 564, 570, 571, 572, 573, 574, 579,
        586, 589, 592, 594, 596, 598, 599, 605, 606, 616, 617, 618, 626, 628, 629, 631, 633, 643, 652, 656, 659, 665,
        669, 670, 671, 675, 695, 698, 701, 705, 707 )
    </select>

    <!-- 查询乐享榜 -->
    <select id="searchLenJoyCount" resultMap="resultMap">
        select count(*) as count,tu.username as username from  tab_lottery_split tls,tab_user tu
		where tls.userid in(
		select userid from tab_user_lottery where lotteryid = 
		(SELECT lotteryid from tab_lottery_split where userid=#{userid}))
		and tu.id=tls.userid
		group by tls.userid limit 20
    </select>

    <!-- 查询领取出票总人数 -->
    <select id="countByTodayTicketCount" resultType="Integer">
        select sum(totalCount) as count from tab_lottery_split where marketid=#{marketid}
        <if test="today != null and today != ''">and date(createtime)=CURDATE()</if>
        and remainderCount=0 and isTuhao=1
    </select>


    <!-- 查询领取出票总人数 -->
    <select id="getByLotteryids" parameterType="String" resultType="LotterySplit">
        SELECT * FROM tab_lottery_split
        WHERE lotteryids in (#{lotteryid})
    </select>

    <!-- 分页查询人气排行榜 -->
    <select id="searchReceiveByUseridAndReceivetime" resultMap="resultMap">
        SELECT ls.userid ,sum(r.cc)count from tab_lottery_split ls ,(SELECT lotteryid ,count(*) cc
        from tab_user_lottery ul
        <where>
            <if test="searchFields.marketid != null and searchFields.marketid != ''">
                and marketid = #{searchFields.marketid}
                <if test="searchFields.marketid == 5">
                    <![CDATA[AND createtime >= '2014-05-30 10:00:00']]>
                </if>
            </if>
            <if test="searchFields.receivetimeType != null and searchFields.receivetimeType != ''">
                and date(ul.createtime) = date(now())
            </if>
            <if test="searchFields.queryDate != null and searchFields.queryDate != ''">
                and date(ul.createtime) = date(#{searchFields.queryDate})
            </if>
        </where>
        GROUP BY ul.lotteryid) r
        where ls.lotteryid = r.lotteryid GROUP BY ls.userid ORDER BY count desc,ls.createtime;
    </select>

    <!-- 查询每日人气排行榜 -->
    <select id="searchTop10" resultMap="resultMap">
        SELECT ls.userid ,sum(r.cc)count,(select username from tab_user where id= ls.userid) as username
         from tab_lottery_split ls ,(SELECT lotteryid ,count(*) cc
        from tab_user_lottery ul
        <where>
            <if test="searchFields.marketid != null and searchFields.marketid != ''">
                and marketid = #{searchFields.marketid}
            </if>
            <if test="searchFields.time != null and searchFields.time != ''">
                and date(ul.createtime) = #{searchFields.time}
            </if>
        </where>
        GROUP BY ul.lotteryid) r
        where ls.lotteryid = r.lotteryid GROUP BY ls.userid ORDER BY count desc,ls.createtime limit 20;
    </select>
    
    <!-- 根据用户id查询 -->
    <select id="searchLotterySplit" resultMap="resultMap">
        select * from tab_lottery_split
        <where>
            <if test="userid != '' and userid != null and userid > 0">
                and userid=#{userid}
            </if>
        </where>
        order by createtime
    </select>

    <select id="searchReceiveTuhao" resultMap="resultMap">
         select * from tab_lottery_split tls,tab_code tc where tc.lotterySplitid=tls.id and tc.userid=#{userid} and tls.marketid=#{marketid} and tls.isTuhao=0
         order by tls.createtime desc
    </select>

    <!-- 查询所有已领土豪包 -->
    <select id="searchTuhao" resultMap="resultMap">
        <![CDATA[
         select * from tab_lottery_split where lotteryid=0 and isTuhao=0 and updatetime is null and createtime <= STR_TO_DATE(#{palmtime},'%Y%m%d%H%i%s')
         order by createtime desc
        ]]>
    </select>

    <!-- 分页查询送出彩票 -->
    <select id="searchSendLotterySplit" resultMap="resultMap">
        select tls.*,tl.isprize,tl.gameid
        from tab_lottery_split tls,tab_lottery tl
        <where>
            <if test="searchFields.userid != null and searchFields.userid != ''">
                and tls.userid=#{searchFields.userid}
            </if>
            <if test="searchFields.marketid != null and searchFields.marketid != ''">
                and tl.marketid=#{searchFields.marketid}
            </if>
            <if test="searchFields.prizetime != null and searchFields.prizetime != ''">
                and tl.prizetime LIKE CONCAT('${searchFields.prizetime}','%' )
            </if>
            and tls.lotteryid=tl.id order by tls.createtime desc
        </where>
    </select>

    <!-- 分页查询领取彩票 -->
    <select id="searchReceiveLottery" resultMap="resultMap">
        select tls.*,tl.isprize,tl.gameid from tab_lottery_split tls,tab_user_lottery tul,tab_lottery tl
        where tls.lotteryid=tul.lotteryid and tl.id=tul.lotteryid
        <if test="searchFields.userid != null and searchFields.userid != ''">
            and tul.userid=#{searchFields.userid}
        </if>
        <if test="searchFields.prizetime != null and searchFields.prizetime != ''">
            and tl.prizetime LIKE CONCAT('${searchFields.prizetime}','%' )
        </if>
        <if test="searchFields.marketid != null and searchFields.marketid != ''">
            and tls.marketid=#{searchFields.marketid}
        </if>
        order by tls.createtime desc
    </select>

    <!-- 获取用户: 输出直接映射到对象 -->
    <select id="get" parameterType="Long" resultType="LotterySplit">
        SELECT
        <include refid="columns"/>
        FROM tab_lottery_split
        WHERE id=#{id}
    </select>

    <!-- 根据彩票ID获取对应拆分情况 -->
    <select id="getByLotteryId" parameterType="Long" resultType="LotterySplit">
        SELECT
        <include refid="columns"/>
        FROM tab_lottery_split
        WHERE lotteryid=#{lotteryid}
    </select>
    <!-- 取得当前活动由当前用户赠送彩票次数(微信)-->
    <select id="getCountByUserid" parameterType="Long" resultType="Integer">
        SELECT count(1) from tab_lottery_split ls where ls.userid =#{userid} and ls.marketid =#{marketid}
        <if test="isTuhao !=null">
            and ls.isTuhao =#{isTuhao}
        </if>

    </select>
    <!-- 取得指定用户未分配完成的数据-->
    <select id="getNotOver" parameterType="Long" resultType="LotterySplit">
       SELECT ls.*,count(1) as ab from tab_lottery_split ls ,tab_user_lottery ul where ul.lotteryid = ls.lotteryid and ls.userid =#{userid} and ls.marketid=#{marketid} GROUP BY ls.lotteryid HAVING ls.totalCount>ab LIMIT 1
    </select>
	
    <!-- 新增 -->
    <insert id="insert" parameterType="LotterySplit" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO tab_lottery_split (
        	id,
			userid,
			lotteryid,
			lotteryids,
			marketid,
			remainderCount,
			remainderPercent,
			isTuhao,
			totalCount,
			updatetime,
			createtime
		) VALUES (
        	#{id},
			#{userid},
			#{lotteryid},
			#{lotteryids},
			#{marketid},
			#{remainderCount},
			#{remainderPercent},
			#{isTuhao},
			#{totalCount},
			#{updatetime},
			#{createtime}
		)
	</insert>

    <!-- 更新 -->
    <update id="update">
        UPDATE tab_lottery_split
        <set>
            <if test="userid != null">
                userid = #{userid},
            </if>
            <if test="lotteryid != null">
                lotteryid = #{lotteryid},
            </if>
            <if test="lotteryids != null">
                lotteryids = #{lotteryids},
            </if>
            <if test="updatetime != null">
                updatetime = #{updatetime},
            </if>
            <if test="remainderCount != null">
                remainderCount = #{remainderCount},
            </if>
            <if test="remainderPercent != null">
                remainderPercent = #{remainderPercent},
            </if>
            <if test="isTuhao != null">
                isTuhao = #{isTuhao},
            </if>
            <if test="totalCount != null">
                totalCount = #{totalCount}
            </if>

        </set>
        WHERE
        id = #{id}
    </update>

    <!-- 删除用户 -->
    <delete id="delete" parameterType="Long">
	     DELETE FROM tab_lottery_split WHERE id=#{id}
	</delete>

</mapper> 
