<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace必须指向Dao接口 -->
<mapper namespace="com.palm.lingcai.repository.LotteryDao">

    <resultMap id="resultMap" type="com.palm.lingcai.entity.Lottery">
        <result property="id" column="id"/>
        <result property="marketid" column="marketid"/>
        <result property="gameid" column="gameid"/>
        <result property="gametype" column="gametype"/>
        <result property="province" column="province"/>
        <result property="orderid" column="orderid"/>
        <result property="palmid" column="palmid"/>
        <result property="money" column="money"/>
        <result property="issueNo" column="issueNo"/>
        <result property="starttime" column="starttime"/>
        <result property="endtime" column="endtime"/>
        <result property="palmtime" column="palmtime"/>
        <result property="ball" column="ball"/>
        <result property="statusCode" column="statusCode"/>
        <result property="sucessFlag" column="sucessFlag"/>
        <result property="palmMsg" column="palmMsg"/>
        <result property="remainder" column="remainder"/>
        <result property="prizetime" column="prizetime"/>
        <result property="createtime" column="createtime"/>
        <result property="modifytime" column="modifytime"/>
        <result property="isprize" column="isprize"/>
        <result property="unitprice" column="unitprice"/>
        <result property="remark" column="remark"/>
        <result property="lotteryStatus" column="lotteryStatus"/>
        <result property="lotterySplit" column="lotterySplit"/>

    </resultMap>


    <!-- 用于select查询公用抽取的列 -->
    <sql id="columns">
		id,marketid,gameid,gametype,province,orderid,palmid,money,issueNo,starttime,endtime,palmtime,ball,statusCode,sucessFlag,palmMsg,remainder,prizetime,createtime,modifytime,unitprice,isprize,remark,lotteryStatus,lotterySplit
	</sql>

    <!-- 查询待出票数据 -->
    <select id="findCheckOutLottery" resultMap="resultMap">
       <![CDATA[
        select a.* from tab_lottery a,(select count(1) AS ab,lotteryid from tab_user_lottery where createtime <= STR_TO_DATE(#{endDate},'%Y%m%d%H%i%s') and lotteryid in ( select tl.id from tab_lottery tl where tl.sucessFlag != 3) group by lotteryid) b,tab_lottery_split c where b.ab = c.totalCount and a.id = b.lotteryid and b.lotteryid = c.lotteryid
        ]]>
    </select>

    <!-- 查询土豪榜或没有拆分的彩票的待出票数据 -->
    <select id="searchTuhaoByLotteryids" resultMap="resultMap">
       <![CDATA[
        select * from tab_lottery a where a.id in (${lotteryids})
        ]]>
    </select>

    <!-- 查询待出票数据,作废，临时处理 -->
    <select id="findCheckOutLotteryCompare" resultMap="resultMap">
        <![CDATA[

        SELECT * from tab_lottery  where id in(SELECT t.lotteryid from tab_lottery_split t where t.remainderCount =0 and t.remainderPercent =0  and marketid =1
		and updatetime > STR_TO_DATE('2014~4~27 19:30:00','%Y~%m~%d %H:%i:%s' )
		and updatetime< STR_TO_DATE('2014~4~27 20:00:00','%Y~%m~%d %H:%i:%s' ))

        ]]>
    </select>

    <!-- 查询错误数据  ，临时处理   -->
    <select id="findNotInLottery" resultMap="resultMap">
        SELECT
        <include refid="columns"/>
        from tab_lottery t where t.unitprice='300' and t.marketid=1 and t.id not in(SELECT s.lotteryid from
        tab_lottery_split s)
    </select>

    <!-- 获取对象: 输出直接映射到对象 -->
    <select id="get" parameterType="Long" resultType="Lottery">
        SELECT
        <include refid="columns"/>
        FROM tab_lottery
        WHERE id=#{id}
    </select>

    <!-- 取得当期余额彩票 -->
    <select id="findSingleLottery" resultType="Lottery">
        SELECT *
        FROM tab_lottery
        <![CDATA[
		WHERE gameid=#{gameid} AND starttime <= #{currentTime} AND endtime >= #{currentTime} AND remainder > 0 AND unitprice = #{unitprice}
		]]> limit 1
    </select>

    <!-- 查询单注彩票领取总人数 -->
    <select id="countByUserLottery" resultType="Lottery">
        <![CDATA[select a.* from tab_lottery a,(select count(1) AS ab,lotteryid from tab_user_lottery where lotteryid=#{id}) b,tab_lottery_split c where b.ab < c.totalCount and a.id = b.lotteryid and b.lotteryid = c.lotteryid]]>
    </select>

    <!-- 取得当期由当前用户发起 并 未领取完成的彩票(微信) -->
    <select id="findSingleLotteryByPercent" resultType="Lottery">
        SELECT *
        FROM tab_lottery l
        <![CDATA[
		WHERE l.id = (
		              SELECT ls.lotteryid from tab_lottery_split ls
		              WHERE ls.userid =#{userid} AND ls.marketid =#{marketid} AND ls.remainderCount>0 AND ls.remainderPercent>0 LIMIT 1
		               )
		]]> limit 1
    </select>

    <!-- 根据code和marketid 获取 对应的split -->
    <select id="getByLotterySplitid" parameterType="Long" resultType="Lottery">
        SELECT
        <include refid="columns"/>
        FROM tab_lottery l
        <![CDATA[

      	 WHERE find_in_set(l.id, (SELECT ls.lotteryids from tab_lottery_split ls where ls.id = #{lotterySplitid}))
        ]]>
    </select>
    <!-- 查询列表, 不分页 -->
    <select id="search" parameterType="map" resultMap="resultMap">
        SELECT
        <include refid="columns"/>
        FROM tab_lottery
        <where>
            <if test="marketid != null and marketid != ''">
                AND marketid = #{marketid}
            </if>
            <if test="gameid != null and gameid != ''">
                AND gameid = #{gameid}
            </if>
            <if test="gametype != null and gametype != ''">
                AND gametype = #{gametype}
            </if>
            <if test="province != null and province != ''">
                AND province = #{province}
            </if>
            <if test="orderid != null and orderid != ''">
                AND orderid = #{orderid}
            </if>
            <if test="palmid != null and palmid != ''">
                AND palmid = #{palmid}
            </if>
            <if test="money != null and money != ''">
                AND money = #{money}
            </if>
            <if test="issueNo != null and issueNo != ''">
                AND issueNo = #{issueNo}
            </if>
            <if test="starttime != null and starttime != ''">
                AND starttime = #{starttime}
            </if>
            <if test="endtime != null and endtime != ''">
                AND endtime = #{endtime}
            </if>
            <if test="palmtime != null and palmtime != ''">
                AND palmtime = #{palmtime}
            </if>
            <if test="ball != null and ball != ''">
                AND ball = #{ball}
            </if>
            <if test="statusCode != null and statusCode != ''">
                AND statusCode = #{statusCode}
            </if>
            <if test="sucessFlag != null">
                AND sucessFlag = #{sucessFlag}
            </if>
            <if test="palmMsg != null and palmMsg != ''">
                AND palmMsg = #{palmMsg}
            </if>
            <if test="remainder != null">
                AND remainder > #{remainder}
            </if>
            <if test="createtime != null and createtime != ''">
                AND createtime = #{createtime}
            </if>
            <if test="modifytime != null and modifytime != ''">
                AND modifytime = #{modifytime}
            </if>
            <if test="unitprice != null and unitprice != ''">
                AND unitprice = #{unitprice}
            </if>
            <if test="remark != null and remark != ''">
                AND remark = #{remark}
            </if>
            <if test="startDate != null and startDate != ''">
                AND date(createtime) >= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                <![CDATA[AND date(createtime) <= #{endDate}]]>
            </if>
            <if test="lotteryStatus != null and lotteryStatus != ''">
                AND lotteryStatus = #{lotteryStatus}
            </if>
            <if test="lotterySplit != null and lotterySplit != ''">
                AND lotterySplit = #{lotterySplit}
            </if>
        </where>
        <if test="sortColumns != null and sortColumns != ''">
            ORDER BY ${sortColumns}
        </if>
    </select>

    <!-- 分页查询 -->
    <select id="searchPage" resultMap="resultMap">
        SELECT
        <include refid="columns"/>
        FROM tab_lottery
        <where>
            <if test="searchFields.marketid != null and searchFields.marketid != ''">
                AND marketid = #{searchFields.marketid}
            </if>
            <if test="searchFields.gameid != null and searchFields.gameid != ''">
                AND gameid = #{searchFields.gameid}
            </if>
            <if test="searchFields.gametype != null and searchFields.gametype != ''">
                AND gametype = #{searchFields.gametype}
            </if>
            <if test="searchFields.province != null and searchFields.province != ''">
                AND province = #{searchFields.province}
            </if>
            <if test="searchFields.orderid != null and searchFields.orderid != ''">
                AND orderid = #{searchFields.orderid}
            </if>
            <if test="searchFields.palmid != null and searchFields.palmid != ''">
                AND palmid = #{searchFields.palmid}
            </if>
            <if test="searchFields.money != null and searchFields.money != ''">
                AND money = #{searchFields.money}
            </if>
            <if test="searchFields.issueNo != null and searchFields.issueNo != ''">
                AND issueNo = #{searchFields.issueNo}
            </if>
            <if test="searchFields.starttime != null and searchFields.starttime != ''">
                AND starttime = #{searchFields.starttime}
            </if>
            <if test="searchFields.endtime != null and searchFields.endtime != ''">
                AND endtime = #{searchFields.endtime}
            </if>
            <if test="searchFields.palmtime != null and searchFields.palmtime != ''">
                AND palmtime = #{searchFields.palmtime}
            </if>
            <if test="searchFields.ball != null and searchFields.ball != ''">
                AND ball = #{searchFields.ball}
            </if>
            <if test="searchFields.statusCode != null and searchFields.statusCode != ''">
                AND statusCode = #{searchFields.statusCode}
            </if>
            <if test="searchFields.sucessFlag != null and searchFields.sucessFlag != ''">
                AND sucessFlag = #{searchFields.sucessFlag}
            </if>
            <if test="searchFields.palmMsg != null and searchFields.palmMsg != ''">
                AND palmMsg = #{searchFields.palmMsg}
            </if>
            <if test="searchFields.remainder != null and searchFields.remainder != ''">
                AND remainder = #{searchFields.remainder}
            </if>
            <if test="searchFields.createtime != null and searchFields.createtime != ''">
                AND createtime = #{searchFields.createtime}
            </if>
            <if test="searchFields.modifytime != null and searchFields.modifytime != ''">
                AND modifytime = #{searchFields.modifytime}
            </if>
            <if test="searchFields.unitprice != null and searchFields.unitprice != ''">
                AND unitprice = #{searchFields.unitprice}
            </if>
            <if test="searchFields.remark != null and searchFields.remark != ''">
                AND remark = #{searchFields.remark}
            </if>
            <if test="searchFields.lotterySplit != null and searchFields.lotterySplit != ''">
                AND lotterySplit = #{searchFields.lotterySplit}
            </if>
        </where>
        <if test="searchFields.sortColumns != null and searchFields.sortColumns != ''">
            ORDER BY ${searchFields.sortColumns}
        </if>
    </select>

    <!-- 分页查询,根据用户ID查询 -->
    <select id="searchPageByUser" resultMap="resultMap">
        SELECT a.*
        FROM tab_lottery a,tab_user_lottery b
        <where>
            <if test="searchFields.isprize != null">
                AND a.isprize = #{searchFields.isprize}
            </if>
            <if test="searchFields.userid != null">
                AND b.userid = #{searchFields.userid}
            </if>
            AND a.id = b.lotteryid
        </where>
        <if test="searchFields.sortColumns != null and searchFields.sortColumns != ''">
            ORDER BY ${searchFields.sortColumns}
        </if>
    </select>

    <!-- 中奖查询 -->
    <select id="searchPrizeList" resultMap="resultMap">
        SELECT a.*,c.prizeball as prizeball,c.prizeMoney as prizeMoney,c.prizeMoneyAfterTax as prizeMoneyAfterTax,c.tax
        as tax
        FROM tab_lottery a,tab_user_lottery b,tab_prize c
        <where>
            <if test="searchFields.userid != null and searchFields.userid != ''">
                AND userid=#{searchFields.userid}
            </if>
            AND a.id=b.lotteryid AND a.issueNo=c.issueNo AND a.gameid=c.gameid
        </where>
    </select>


    <!-- 金额统计 -->
    <select id="statisLottery" resultType="map">
        SELECT sum(money) as totalMoney,count(1) as allCount
        FROM tab_lottery
        <where>
            <if test="startDate != null and startDate != ''">
                AND date(createtime) >= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                <![CDATA[AND date(createtime) <= #{endDate}]]>
            </if>
            AND sucessFlag=3
        </where>
    </select>

    <!-- 统计数据 -->
    <select id="count" parameterType="map" resultType="int">
        SELECT count(1)
        FROM tab_lottery
        <where>
            <if test="marketid != null and marketid != ''">
                AND marketid = #{marketid}
            </if>
            <if test="gameid != null and gameid != ''">
                AND gameid = #{gameid}
            </if>
            <if test="gametype != null and gametype != ''">
                AND gametype = #{gametype}
            </if>
            <if test="province != null and province != ''">
                AND province = #{province}
            </if>
            <if test="orderid != null and orderid != ''">
                AND orderid = #{orderid}
            </if>
            <if test="palmid != null and palmid != ''">
                AND palmid = #{palmid}
            </if>
            <if test="money != null and money != ''">
                AND money = #{money}
            </if>
            <if test="issueNo != null and issueNo != ''">
                AND issueNo = #{issueNo}
            </if>
            <if test="starttime != null and starttime != ''">
                AND starttime = #{starttime}
            </if>
            <if test="endtime != null and endtime != ''">
                AND endtime = #{endtime}
            </if>
            <if test="palmtime != null and palmtime != ''">
                AND palmtime = #{palmtime}
            </if>
            <if test="ball != null and ball != ''">
                AND ball = #{ball}
            </if>
            <if test="statusCode != null and statusCode != ''">
                AND statusCode = #{statusCode}
            </if>
            <if test="sucessFlag != null and sucessFlag != ''">
                AND sucessFlag = #{sucessFlag}
            </if>
            <if test="palmMsg != null and palmMsg != ''">
                AND palmMsg = #{palmMsg}
            </if>
            <if test="remainder != null and remainder != ''">
                AND remainder = #{remainder}
            </if>
            <if test="createtime != null and createtime != ''">
                AND createtime = #{createtime}
            </if>
            <if test="modifytime != null and modifytime != ''">
                AND modifytime = #{modifytime}
            </if>
            <if test="unitprice != null and unitprice != ''">
                AND unitprice = #{unitprice}
            </if>
            <if test="lotterySplit != null and lotterySplit != ''">
                AND lotterySplit = #{lotterySplit}
            </if>
        </where>
    </select>

    <!-- 新增 -->
    <insert id="insert" parameterType="Lottery" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO tab_lottery (
        	marketid,
        	gameid,
        	gametype,
        	province,
        	orderid,
        	palmid,
        	money,
        	issueNo,
        	starttime,
        	endtime,
        	palmtime,
        	ball,
        	statusCode,
        	sucessFlag,
        	palmMsg,
        	remainder,
        	prizetime,
        	createtime,
        	modifytime,
        	isprize,
        	unitprice,
        	remark,
        	lotteryStatus,
        	lotterySplit
		) VALUES (
        	#{marketid},
        	#{gameid},
        	#{gametype},
        	#{province},
        	#{orderid},
        	#{palmid},
        	#{money},
        	#{issueNo},
        	#{starttime},
        	#{endtime},
        	#{palmtime},
        	#{ball},
        	#{statusCode},
        	#{sucessFlag},
        	#{palmMsg},
        	#{remainder},
        	#{prizetime},
        	#{createtime},
        	#{modifytime},
        	#{isprize},
        	#{unitprice},
        	#{remark},
        	#{lotteryStatus},
        	#{lotterySplit}
		)
	</insert>

    <!-- 更新 -->
    <update id="update">
        UPDATE tab_lottery
        <set>
            <if test="marketid != null">
                marketid = #{marketid},
            </if>
            <if test="gameid != null">
                gameid = #{gameid},
            </if>
            <if test="gametype != null">
                gametype = #{gametype},
            </if>
            <if test="province != null">
                province = #{province},
            </if>
            <if test="orderid != null">
                orderid = #{orderid},
            </if>
            <if test="palmid != null">
                palmid = #{palmid},
            </if>
            <if test="money != null">
                money = #{money},
            </if>
            <if test="issueNo != null">
                issueNo = #{issueNo},
            </if>
            <if test="starttime != null">
                starttime = #{starttime},
            </if>
            <if test="endtime != null">
                endtime = #{endtime},
            </if>
            <if test="palmtime != null">
                palmtime = #{palmtime},
            </if>
            <if test="ball != null">
                ball = #{ball},
            </if>
            <if test="statusCode != null">
                statusCode = #{statusCode},
            </if>
            <if test="sucessFlag != null">
                sucessFlag = #{sucessFlag},
            </if>
            <if test="palmMsg != null">
                palmMsg = #{palmMsg},
            </if>
            <if test="remainder != null">
                remainder = #{remainder},
            </if>
            <if test="prizetime != null">
                prizetime = #{prizetime},
            </if>
            <if test="createtime != null">
                createtime = #{createtime},
            </if>
            <if test="modifytime != null">
                modifytime = #{modifytime},
            </if>
            <if test="isprize != null">
                isprize = #{isprize},
            </if>
            <if test="unitprice != null">
                unitprice = #{unitprice},
            </if>
            <if test="remark != null">
                remark = #{remark},
            </if>
            <if test="lotteryStatus != null">
                lotteryStatus = #{lotteryStatus},
            </if>
            <if test="lotterySplit != null">
                lotterySplit = #{lotterySplit}
            </if>
        </set>
        WHERE
        id = #{id}
    </update>

    <!-- 根据订单号更新 -->
    <update id="updateForOrder">
        UPDATE tab_lottery
        <set>
            <if test="palmid != null and palmid != ''">
                palmid = #{palmid},
            </if>
            <if test="statusCode != null and statusCode != ''">
                statusCode = #{statusCode},
            </if>
            <if test="sucessFlag != null and sucessFlag != ''">
                sucessFlag = #{sucessFlag},
            </if>
        </set>
        WHERE
        orderid = #{orderid}
    </update>

    <!-- 根据订单号更新 -->
    <update id="updateIsPrize">
        UPDATE tab_lottery
        <set>
            <if test="isprize != null">
                isprize = #{isprize}
            </if>
        </set>
        <where>
            <if test="issueNo != null and issueNo != ''">
                AND issueNo = #{issueNo}
            </if>
            <if test="sucessFlag != null">
                AND sucessFlag = #{sucessFlag}
            </if>
            <if test="gameid != null and gameid != ''">
                AND gameid = #{gameid}
            </if>
            <if test="orderid != null and orderid != ''">
                AND orderid = #{orderid}
            </if>
            <if test="palmid != null and palmid != ''">
                AND palmid = #{palmid}
            </if>
        </where>
    </update>

    <!-- 更新剩余票，减1 -->
    <update id="updateRemainder">
        UPDATE tab_lottery SET remainder = remainder-1 WHERE id=#{id}
    </update>

    <!-- 更新出票状态,用于回调时更新 -->
    <update id="updateTicket">
        UPDATE tab_lottery SET sucessFlag = #{sucessFlag} WHERE id=#{id}
    </update>

    <!-- 更新期号信息 -->
    <update id="updateIssueNo">
        UPDATE tab_lottery
        <set>
            <if test="issueNo != null and issueNo != ''">
                issueNo = #{issueNo},
            </if>
            <if test="modifytime != null">
                modifytime = #{modifytime},
            </if>
            lotteryStatus = 1
        </set>
        WHERE
        id = #{id}
    </update>

    <!-- 删除用户 -->
    <delete id="delete" parameterType="Long">
	     DELETE FROM tab_lottery WHERE id=#{id}
	</delete>

    <!-- 统计彩票情况 -->
    <select id="countLottery" resultType="int">
        SELECT
        count(1)
        FROM tab_lottery
        <where>
            <if test="marketid != null and marketid != ''">
                AND marketid = #{marketid}
            </if>
            <if test="issueNo != null and issueNo != ''">
                AND issueNo = #{issueNo}
            </if>
            <if test="isprize != null and isprize != ''">
                AND isprize = #{isprize}
            </if>
            <if test="sucessFlag != null">
                AND sucessFlag = #{sucessFlag}
            </if>
            <if test="starttime != null and starttime != ''">
                AND createtime >= #{starttime}
            </if>
            <if test="endtime != null and endtime != ''">
                <![CDATA[and createtime <= #{endtime}]]>
            </if>
             <if test="startModifytime != null and startModifytime != ''">
                AND modifytime >= #{startModifytime}
            </if>
            <if test="endModifytime != null and endModifytime != ''">
                <![CDATA[and modifytime <= #{endModifytime}]]>
            </if>
        </where>
    </select>
	  <!-- 查询世界杯兑奖订单 -->
     <select id="searchByWCWaitPrize" resultMap="resultMap">
        SELECT  *
        FROM tab_lottery
        <where>
        	 sucessFlag = 3
            <if test="gametype != null and gametype != ''">
                AND gametype = #{gametype}
            </if>
            <if test="isprize != null and isprize != ''">
                AND isprize = #{isprize}
            </if>
            <![CDATA[AND  DATE_FORMAT(prizetime,'%Y%m%d%H%i%s') <= DATE_FORMAT(now() ,'%Y%m%d%H%i%s') ]]>
            
             <if test="item != null and item != ''">
           	   limit #{item}         
            </if>
        </where>
    </select>


    <!-- 查询世界杯出错数据待出票的定单 -->
    <select id="searchByWrongTicket" resultMap="resultMap">
        SELECT  *
        FROM tab_lottery
        WHERE remark = '1001'
    </select>


    <!-- 查询世界杯应该出票但是因为各种情况未出票的定单 -->
    <select id="searchByUnTicket" resultMap="resultMap">
        select lotteryid as id from tab_user_lottery where lotteryid in (select id from tab_lottery where sucessFlag != 3 and gametype=3 and id > 165189) group by lotteryid
    </select>
    
    <select id="findLotteryByOrderId" resultType="Lottery">
        select *
        from 
        tab_lottery
        where orderid =#{orderid}
    </select>
    
</mapper>
