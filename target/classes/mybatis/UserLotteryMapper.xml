<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace必须指向Dao接口 -->
<mapper namespace="com.palm.lingcai.repository.UserLotteryDao">

	<resultMap id="resultMap" type="com.palm.lingcai.entity.UserLottery">
		<result property="id" column="id" />
		<result property="userid" column="userid" />
		<result property="username" column="username" />
		<result property="lotteryid" column="lotteryid" />
		<result property="marketid" column="marketid" />
		<result property="drawid" column="drawid"/>
		<result property="money" column="money" />
		<result property="reqHead" column="reqHead" />
		<result property="referer" column="referer" />
		<result property="source" column="source" />
		<result property="author" column="author" />
		<result property="scanip" column="scanip" />
		<result property="createtime" column="createtime" />
		<result property="remark" column="remark" />
		<result property="gainPercent" column="gainPercent" />
		<result property="isSend" column="isSend" />
		<result property="groupid" column="groupid" />
		<result property="cid" column="cid" />
 		<result property="orderid" column="orderid" /> 
 		<result property="serialno" column="serialno" /> 
 		<result property="channelOrder" column="channelOrder" /> 
 		<result property="notifyStatus" column="notify_status" /> 
 		<result property="notifyTimes" column="notify_times" /> 
 		<result property="notifyWinStatus" column="notify_win_status" /> 
 		<result property="notifyWinTimes" column="notify_win_times" /> 
	</resultMap>
	
	<resultMap id="interactUserResultMap" type="com.palm.lingcai.entity.InteractUserInfo">
		<result property="userid" column="userid" />
		<result property="num" column="num" />
		<association property="userWeixinInfo" column="userid" javaType="UserWeixinInfo" select="com.palm.lingcai.repository.UserWeixinInfoDao.getUserWeixinInfoByUserid"/> 
	</resultMap>

	<!-- 用于select查询公用抽取的列 -->
	<sql id="columns">
		id,userid,username,lotteryid,marketid,drawid,money,reqHead,referer,source,author,scanip,createtime,remark,gainPercent,isSend,groupid,cid
 		,orderid,serialno,channelOrder,notify_status,notify_times,notify_win_status,notify_win_times
	</sql>

	<!-- 获取用户: 输出直接映射到对象 -->
	<select id="get" parameterType="Long" resultType="UserLottery">
		SELECT
		<include refid="columns" />
		FROM tab_user_lottery
		WHERE id=#{id}
	</select>

	<!-- 根据用户ID和彩票ID获取用户领取的彩票明细 -->
	<select id="getByUserAndLottery" resultType="UserLottery">
		SELECT *
		FROM
		tab_user_lottery
		WHERE userid=#{userid} AND lotteryid=#{lotteryid}
		order by id desc limit 1
	</select>

	<!-- 根据订单ID查询用户零彩信息 -->
	<select id="findByOrderid" resultMap="resultMap">
		SELECT a.*
		FROM
		tab_user_lottery a,tab_lottery b
		WHERE b.orderid=#{orderid} AND
		a.lotteryid=b.id
	</select>

	<!-- 获取用户: 根据电话号码 -->
	<select id="findByMobile" parameterType="String" resultType="UserLottery">
		SELECT
		<include refid="columns" />
		FROM tab_user_lottery
		WHERE username=#{mobile} and marketid =
		#{marketid} ORDER BY createtime
		DESC limit 1
	</select>

	<!-- 查询用户, 不分页 -->
	<select id="search" parameterType="map" resultMap="resultMap">
		SELECT
		<include refid="columns" />
		FROM tab_user_lottery
		<where>
			<if test="userid != null and userid != ''">
				AND userid = #{userid}
			</if>
			<if test="lotteryid != null and lotteryid != ''">
				AND lotteryid = #{lotteryid}
			</if>
			<if test="marketid != null and marketid != ''">
				AND marketid = #{marketid}
			</if>
			<if test="drawid != null and drawid != ''">
				AND drawid = #{drawid}
			</if>
			<if test="money != null and money != ''">
				AND money = #{money}
			</if>
			<if test="reqHead != null and reqHead != ''">
				AND reqHead = #{reqHead}
			</if>
			<if test="referer != null and referer != ''">
				AND referer = #{referer}
			</if>
			<if test="source != null and source != ''">
				AND source = #{source}
			</if>
			<if test="createtime != null and createtime != ''">
				AND createtime = #{createtime}
			</if>
			<if test="remark != null and remark != ''">
				AND remark = #{remark}
			</if>
			<if test="groupid != null and groupid != ''">
				AND groupid = #{groupid}
			</if>
			<if test="cid != null and cid != ''">
				AND cid = #{cid}
			</if>
		</where>
		<if test="sortColumns != null and sortColumns != ''">
			ORDER BY ${sortColumns}
		</if>
	</select>

	<!-- 分页查询 -->
	<select id="searchPage" resultMap="resultMap">
		SELECT a.*,b.ball as ball,b.issueNo as issueNo,c.marketName as
		marketName,b.sucessFlag as sucessFlag,b.gameid as
		gameid,b.isprize as
		isprize,b.prizetime as prizetime
		FROM tab_user_lottery a,tab_lottery
		b,tab_marketplan c
		<where>
			<if test="searchFields.userid != null and searchFields.userid != ''">
				AND a.userid = #{searchFields.userid}
			</if>
			<if test="searchFields.username != null and searchFields.username != ''">
				AND a.username = #{searchFields.username}
			</if>
			<if test="searchFields.lotteryid != null and searchFields.lotteryid != ''">
				AND a.lotteryid = #{searchFields.lotteryid}
			</if>
			<if test="searchFields.marketid != null and searchFields.marketid != ''">
				AND a.marketid = #{searchFields.marketid}
			</if>
			<if test="searchFields.drawid != null and searchFields.drawid != ''">
				AND a.drawid = #{searchFields.drawid}
			</if>
			<if test="searchFields.money != null and searchFields.money != ''">
				AND a.money = #{searchFields.money}
			</if>
			<if test="searchFields.reqHead != null and searchFields.reqHead != ''">
				AND a.reqHead = #{searchFields.reqHead}
			</if>
			<if test="searchFields.referer != null and searchFields.referer != ''">
				AND a.referer = #{searchFields.referer}
			</if>
			<if test="searchFields.source != null and searchFields.source != ''">
				AND a.source = #{searchFields.source}
			</if>
			<if test="searchFields.startdate != null and searchFields.startdate != ''">
				AND date(a.createtime) >= #{searchFields.startdate}
			</if>
			<if test="searchFields.enddate != null and searchFields.enddate != ''">
                <![CDATA[AND date(a.createtime) <= #{searchFields.enddate}]]>
			</if>
			<if test="searchFields.remark != null and searchFields.remark != ''">
				AND a.remark = #{searchFields.remark}
			</if>
			<if test="searchFields.isprize != null and searchFields.isprize != ''">
				AND b.isprize = #{searchFields.isprize}
			</if>
			AND a.lotteryid = b.id AND b.marketid = c.id
		</where>
		<if
			test="searchFields.sortColumns != null and searchFields.sortColumns != ''">
			ORDER BY ${searchFields.sortColumns}
		</if>
	</select>

	<!-- 新增 -->
	<insert id="insert" parameterType="UserLottery"
		useGeneratedKeys="true" keyProperty="id">
		INSERT INTO tab_user_lottery (
		userid,
		username,
		lotteryid,
		marketid,
		drawid,
		money,
		reqHead,
		referer,
		source,
		author,
		scanip,
		createtime,
		gainPercent,
		isSend,
		remark,
		groupid,
		cid,
		orderid,
		channelOrder,
		notify_status,
		notify_times,
		notify_win_status,
		notify_win_times
		) VALUES
		(
		#{userid},
		#{username},
		#{lotteryid},
		#{marketid},
		#{drawid},
		#{money},
		#{reqHead},
		#{referer},
		#{source},
		#{author},
		#{scanip},
		#{createtime},
		#{gainPercent},
		#{isSend},
		#{remark},
		#{groupid},
		#{cid},
		#{orderid},
		#{channelOrder},
		#{notifyStatus},
		#{notifyTimes},
		#{notifyWinStatus},
		#{notifyWinTimes}
		)
	</insert>

	<!-- 更新 -->
	<update id="update">
		UPDATE tab_user_lottery
		<set>
			<if test="userid != null">
				userid = #{userid},
			</if>
			<if test="username != null">
				username = #{username},
			</if>
			<if test="lotteryid != null">
				lotteryid = #{lotteryid},
			</if>
			<if test="marketid != null">
				marketid = #{marketid},
			</if>
			<if test="drawid != null">
				drawid = #{drawid},
			</if>
			<if test="money != null">
				money = #{money},
			</if>
			<if test="reqHead != null">
				reqHead = #{reqHead},
			</if>
			<if test="referer != null">
				referer = #{referer},
			</if>
			<if test="source != null">
				source = #{source},
			</if>
			<if test="author != null">
				author = #{author},
			</if>
			<if test="scanip != null">
				scanip = #{scanip},
			</if>
			<if test="createtime != null">
				createtime = #{createtime},
			</if>
			<if test="gainPercent != null">
				gainPercent = #{gainPercent},
			</if>
			<if test="remark != null">
				remark = #{remark},
			</if>
			<if test="groupid != null">
				groupid = #{groupid},
			</if>
			<if test="cid != null">
				cid = #{cid}
			</if>
		</set>
		WHERE
		id = #{id}
	</update>

	<!-- 删除用户 -->
	<delete id="delete" parameterType="Long">
		DELETE FROM tab_user_lottery
		WHERE id=#{id}
	</delete>


	<!-- 查询用户彩票信息 -->
	<select id="findUserLottery" resultMap="resultMap">
		SELECT
		<include refid="columns" />
		FROM tab_user_lottery
		<where>
			<if test="searchFields.userid != null and searchFields.userid != ''">
				AND userid = #{searchFields.userid}
			</if>
			<if test="searchFields.lotteryid != null and searchFields.lotteryid != ''">
				AND lotteryid = #{searchFields.lotteryid}
			</if>
			<if test="searchFields.marketid != null and searchFields.marketid != ''">
				AND marketid = #{searchFields.marketid}
			</if>
			<if test="searchFields.drawid != null and searchFields.drawid != ''">
				AND drawid = #{searchFields.drawid}
			</if>
			<if
				test="searchFields.createtime != null and searchFields.createtime != ''">
				AND createtime = #{searchFields.createtime}
			</if>
			<if test="searchFields.groupid != null and searchFields.groupid != ''">
				AND groupid = #{searchFields.groupid}
			</if>
			<if test="searchFields.cid != null and searchFields.cid != ''">
				AND cid = #{searchFields.cid}
			</if>
		</where>
	</select>


	<!-- 分页查询 -->
	<select id="searchPageUserLottery" resultMap="resultMap">
		SELECT *
		FROM tab_user_lottery 
		<where>
			<if test="searchFields.userid != null and searchFields.userid != ''">
				AND userid = #{searchFields.userid}
			</if>
			<if test="searchFields.username != null and searchFields.username != ''">
				AND username = #{searchFields.username}
			</if>
			<if test="searchFields.lotteryid != null and searchFields.lotteryid != ''">
				AND lotteryid = #{searchFields.lotteryid}
			</if>
			<if test="searchFields.marketid != null and searchFields.marketid != ''">
				AND marketid = #{searchFields.marketid}
			</if>
			<if test="searchFields.drawid != null and searchFields.drawid != ''">
				AND drawid = #{searchFields.drawid}
			</if>
			<if test="searchFields.money != null and searchFields.money != ''">
				AND money = #{searchFields.money}
			</if>
			<if test="searchFields.reqHead != null and searchFields.reqHead != ''">
				AND reqHead = #{searchFields.reqHead}
			</if>
			<if test="searchFields.referer != null and searchFields.referer != ''">
				AND referer = #{searchFields.referer}
			</if>
			<if test="searchFields.source != null and searchFields.source != ''">
				AND source = #{searchFields.source}
			</if>
			<if test="searchFields.startdate != null and searchFields.startdate != ''">
				AND date(createtime) >= #{searchFields.startdate}
			</if>
			<if test="searchFields.enddate != null and searchFields.enddate != ''">
                <![CDATA[AND date(createtime) <= #{searchFields.enddate}]]>
			</if>
			<if test="searchFields.remark != null and searchFields.remark != ''">
				AND remark = #{searchFields.remark}
			</if>
			<if test="searchFields.isprize != null and searchFields.isprize != ''">
				AND isprize = #{searchFields.isprize}
			</if>
			<if test="searchFields.cid != null and searchFields.cid != ''">
				AND cid = #{searchFields.cid}
			</if>
			<if test="searchFields.groupid != null and searchFields.groupid != ''">
				AND groupid = #{searchFields.groupid}
			</if>
		</where>
		<if test="searchFields.sortColumns != null and searchFields.sortColumns != ''">
				ORDER BY ${searchFields.sortColumns}
		</if>
	</select>
	
    
    <!-- =================lingcai api========================= -->
    <select id="findOnlyChannelOrder"  resultType="UserLottery">
        select *
        from tab_user_lottery
	    where 1=1
	    <if test="channelOrder != null and channelOrder != ''">
	      AND channelOrder=#{channelOrder} 
	    </if>
	    <if test="marketId != null and marketId != ''">
	   	 AND marketid=#{marketId}
	    </if>
    </select>
    
	<!-- 查询出票成功订单 -->
	<select id="searchNotifyOrder" resultType="java.util.HashMap">
     	SELECT t.id as userLotteryId,t.channelOrder,lot.sucessFlag,lot.gameid,t.money,lot.ball,lot.issueNo,p.code3 as notify_url,m.market_app_secret 
		FROM tab_user_lottery t
		INNER join tab_lottery lot ON lot.id = t.lotteryid
		INNER join tab_sys_param p ON p.code1 = t.marketid
		INNER JOIN tab_marketplan m on m.id = t.marketid
		WHERE p.code2 = 'NOTIFY_URL'
		AND t.notify_status ='N'
		<if test="successFlag != null and successFlag != ''">
			AND lot.sucessFlag= #{successFlag}
		</if>
		<if test="notifyTimes != null and notifyTimes != ''">
			<![CDATA[ and t.notify_times < #{notifyTimes} ]]>
		</if>
		<if test="quantity != null and quantity != ''">
		  	limit #{quantity}
		</if>
   	</select>
	
	<!-- 推送中奖订单查询 -->
	<select id="notifyWin" resultType="java.util.HashMap">
     	SELECT l.id as userLotteryId,l.channelOrder,lot.issueNo,lot.gameid,p.prizeMoney,up.prizeMoneyAfterTax as rewardMoney,p.prizeball,p.prizeLevel,p.prizeMoneyAfterTax,p.tax
     			,m.market_app_secret,s.code3 as notify_win_url 
		FROM tab_user_lottery l
		INNER JOIN tab_user_prize up ON up.userLotteryId = l.id
		INNER JOIN tab_lottery lot ON lot.id = l.lotteryid
		INNER JOIN tab_prize p on p.id = up.prizeid
		INNER JOIN tab_marketplan m ON m.id = l.marketid
		INNER JOIN tab_sys_param s ON s.code1 = l.marketid AND s.code2 = 'NOTIFY_WIN_URL'
		WHERE l.notify_win_status = 'N'
 		<if test="notifyWinTimes != null and notifyWinTimes != ''">
			<![CDATA[ AND l.notify_win_times < #{notifyWinTimes}  ]]>
		</if>
		<if test="quantity != null and quantity != ''">
		  	limit #{quantity}
		</if>
	</select>
   
	<!-- 更新订单状态推送 -->
	<update id="updateNotifyStatus" >
		 UPDATE tab_user_lottery
		<set>
			notify_status = #{notifyStatus},
			notify_times = notify_times+1
		</set>
        WHERE 
	        id = #{id}
	</update>
	<!-- 更新订单中奖状态推送 -->
	<update id="updateWinStatus" >
		 UPDATE tab_user_lottery
		<set>
			notify_win_status = #{winStatus},
			notify_win_times = notify_win_times+1
		</set>
        WHERE 
	        id = #{id}
	</update>
	
	<!-- 订单状态查询 -->
	<select id="findChannelOrderStatus" resultType="java.util.HashMap">
		SELECT t.channelOrder,lot.sucessFlag,lot.issueNo,lot.ball
		FROM tab_user_lottery t ,tab_lottery lot
		WHERE t.lotteryid= lot.id 
		<if test="marketplanId != null and marketplanId != ''">
			AND t.marketid=#{marketplanId}
		</if>
 		<if test="mobile != null and mobile != ''">
			AND t.username=#{mobile}
		</if>
		<if test="gameId != null and gameId != ''">
			AND lot.gameid=#{gameId}
		</if>
		AND t.channelOrder IN
        <foreach item="item" index="index" collection="orderIds" open="(" separator="," close=")">
              #{item}
      	</foreach>
   </select>

   <!-- 订单对账统计-->
   <select id="checkAccountOrder" resultType="java.util.HashMap">
       SELECT COUNT(1) AS countTotal, SUM(t.money) moneyTotal ,lot.gameid,lot.issueNo
       FROM tab_user_lottery t ,tab_lottery lot
       WHERE t.lotteryid=lot.id
       	 AND t.marketid = #{marketid}
       	 AND lot.gameid = #{gameId}
        <if test="checkType== 1 ">
			<![CDATA[ AND t.issue_no=#{typeNo}]]>
		</if>
		 <if test="checkType== 2 ">
			<![CDATA[AND date_format(t.createtime,'%Y-%m-%d')= CURDATE()]]>
		</if>
		 <if test="checkType== 3 ">
			<![CDATA[AND date_format(t.createtime,'%Y-%m')=date_format(#{typeNo},'%Y-%m')]]>
		</if>
   </select>
</mapper> 
