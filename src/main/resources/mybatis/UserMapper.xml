<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace必须指向Dao接口 -->
<mapper namespace="com.palm.lingcai.repository.UserDao">

    <resultMap id="resultMap" type="com.palm.lingcai.entity.User">
        <result property="id" column="id"/>
        <result property="username" column="username"/>
        <result property="pwd" column="pwd"/>
        <result property="pwdSalt" column="pwdSalt"/>
        <result property="payPwd" column="payPwd"/>
        <result property="payPwdSalt" column="payPwdSalt"/>
        <result property="realName" column="realName"/>
        <result property="cardType" column="cardType"/>
        <result property="cardNo" column="cardNo"/>
        <result property="email" column="email"/>
        <result property="mobile" column="mobile"/>
        <result property="mobileArea" column="mobileArea"/>
        <result property="gender" column="gender"/>
        <result property="qq" column="qq"/>
        <result property="phone" column="phone"/>
        <result property="address" column="address"/>
        <result property="zipcode" column="zipcode"/>
        <result property="avatar" column="avatar"/>
        <result property="regip" column="regip"/>
        <result property="company" column="company"/>
        <result property="licenseScan" column="licenseScan"/>
        <result property="userType" column="userType"/>
        <result property="balance" column="balance"/>
        <result property="salt" column="salt"/>
        <result property="lastTime" column="lastTime"/>
        <result property="flag" column="flag"/>
        <result property="source" column="source"/>
        <result property="logintimes" column="logintimes"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="createTime"/>
        <result property="modifyTime" column="modifyTime"/>
        <result property="openid" column="openid"/>
        <result property="prize" column="prize"/>
        <result property="lastPrizeTime" column="lastPrizeTime"/>
        <result property="warnBalance" column="warnBalance"/>
        <result property="warnFlag" column="warnFlag"/>
    </resultMap>

    <!-- 用于select查询公用抽取的列 -->
    <sql id="columns">
		id,username,pwd,pwdSalt,payPwd,payPwdSalt,realName,cardType,cardNo,email,mobile,mobileArea,gender,qq,phone,address,zipcode,avatar,regip,company,licenseScan,userType,balance,salt,lastTime,flag,source,logintimes,remark,createTime,modifyTime,openid,prize,lastPrizeTime
		,warnBalance,warnFlag
	</sql>

     <!-- 查询中奖用户信息 -->
    <select id="serachUserPrizeInfo" resultMap="resultMap">
        SELECT * FROM tab_user_prize tup,tab_user tu where tu.id=tup.userid
        <if test="issueNo != '' and issueNo != null">
            and tup.issueNo=#{issueNo}
        </if>
        <if test="gameid != '' and gameid != null">
            and tup.gameid=#{gameid}
        </if>
    </select>
    
    <!-- 获取用户: 输出直接映射到对象 -->
     <resultMap id="resultMap_User" type="com.palm.lingcai.entity.User">
        <result property="id" column="id"/>
        <result property="username" column="username"/>
        <result property="pwd" column="pwd"/>
        <result property="pwdSalt" column="pwdSalt"/>
        <result property="payPwd" column="payPwd"/>
        <result property="payPwdSalt" column="payPwdSalt"/>
        <result property="realName" column="realName"/>
        <result property="cardType" column="cardType"/>
        <result property="cardNo" column="cardNo"/>
        <result property="email" column="email"/>
        <result property="mobile" column="mobile"/>
        <result property="mobileArea" column="mobileArea"/>
        <result property="gender" column="gender"/>
        <result property="qq" column="qq"/>
        <result property="phone" column="phone"/>
        <result property="address" column="address"/>
        <result property="zipcode" column="zipcode"/>
        <result property="avatar" column="avatar"/>
        <result property="regip" column="regip"/>
        <result property="company" column="company"/>
        <result property="licenseScan" column="licenseScan"/>
        <result property="userType" column="userType"/>
        <result property="balance" column="balance"/>
        <result property="salt" column="salt"/>
        <result property="lastTime" column="lastTime"/>
        <result property="flag" column="flag"/>
        <result property="source" column="source"/>
        <result property="logintimes" column="logintimes"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="createTime"/>
        <result property="modifyTime" column="modifyTime"/>
        <result property="openid" column="openid"/>
        <collection property="balanceList" ofType="Balance" column="id" 	
        	select="com.palm.lingcai.repository.BalanceDao.findBalancesByUserId">
        </collection>
    </resultMap>
    
    <select id="get" parameterType="Long" resultMap="resultMap_User">
        SELECT * FROM tab_user
        WHERE id=#{id}
    </select>

    <!-- 获取用户角色关联数据-->
    <select id="findRoleLinks" parameterType="Long" resultType="Role">
		SELECT b.id,b.name,b.description,b.rule
		FROM tab_user_role a, tab_role b
		WHERE a.userid=#{userId} and a.roleid = b.id
	</select>

    <!-- 根据用户名获取用户-->
    <select id="findByUserName" resultType="User">
        SELECT *
        FROM tab_user
        WHERE username=#{username} limit 1
    </select>
    
    <!-- 根据用户名 + 登录模式获取用户-->
    <select id="findUserByUserType" resultType="User">
        SELECT *
        FROM tab_user
        WHERE username=#{username} AND (userType=#{userType} or userType=3) 
    </select>

    <!-- 根据email获取用户-->
    <select id="findByEmail" resultType="User">
        SELECT * FROM tab_user
        WHERE email=#{email}
        <if test="id != null">
            AND id != #{id}
        </if>
    </select>

    <!-- 根据手机号获取用户-->
    <select id="findByMobile" parameterType="String" resultType="User">
        SELECT * FROM tab_user
        WHERE username=#{mobile}
    </select>
    
     <!-- count user-->
    <select id="countUser" parameterType="String" resultType="int">
        SELECT count(*) FROM tab_user
        WHERE mobile=#{mobile}
    </select>

    <!-- 校验密码是否正确-->
    <select id="findByPwd" resultType="User">
        SELECT * FROM tab_user
        WHERE id=#{userid} and pwd=#{pwd}
    </select>

    <!-- 通过用户名和密码查询用户是否存在-->
    <select id="findByPwdAndUserName" resultType="User">
        SELECT * FROM tab_user
        WHERE username=#{username} and pwd=#{pwd}
    </select>

    <!-- 根据用户定制的所有计划统计所获得的用户总数-->
    <select id="countByUserMarket" resultType="int">
        SELECT COUNT(DISTINCT b.id) from tab_user_lottery a,tab_user b where a.marketid in (select id from tab_marketplan where userid=#{userid}) and a.userid = b.id
    </select>

    <!-- 余额对账 -->
    <select id="balanceConfirm" resultType="map">
        select sum(a.amount) as amount,b.balance as balance from tab_bill a,tab_user b where a.userId=#{userid} and a.billret=1 and a.userId = b.id
    </select>

    <!-- 根据用户定制的所有计划查询所获得的用户列表-->
    <select id="searchByUserMarket" resultType="User">
        SELECT b.*,sum(b.id) from tab_user_lottery a,tab_user b where a.marketid in (select id from tab_marketplan where userid=#{userid}) and a.userid = b.id GROUP BY b.id
    </select>

    <!-- 查询用户, 不分页 -->
    <select id="search" parameterType="map" resultMap="resultMap">
        SELECT
        <include refid="columns"/>
        FROM tab_user
        <where>
            AND flag != 2
            <if test="username != null and username != ''">
                AND username = #{username}
            </if>
            <if test="id != null">
                AND id = #{id}
            </if>
            <if test="realName != null and realName != ''">
                AND realName = #{realName}
            </if>
            <if test="email != null and email != ''">
                AND email = #{email}
            </if>
            <if test="mobile != null and mobile != ''">
                AND mobile = #{mobile}
            </if>
            <if test="mobileArea != null and mobileArea != ''">
                AND mobileArea = #{mobileArea}
            </if>
            <if test="gender != null and gender != ''">
                AND gender = #{gender}
            </if>
            <if test="phone != null and phone != ''">
                AND phone = #{phone}
            </if>
            <if test="address != null and address != ''">
                AND address = #{address}
            </if>
            <if test="avatar != null and avatar != ''">
                AND avatar is not null
            </if>
            <if test="company != null and company != ''">
                AND company = #{company}
            </if>
            <if test="logintimes != null and logintimes != ''">
                AND logintimes = #{logintimes}
            </if>
            <if test="licenseScan != null and licenseScan != ''">
                AND licenseScan is not null
            </if>
            <if test="userType != null and userType != ''">
                AND userType = #{userType}
            </if>
            <if test="createTime != null and createTime != ''">
                AND createTime = #{createTime}
            </if>
        </where>
    </select>

    <!-- 分页查询 -->
    <select id="searchPage" resultMap="resultMap">
        SELECT
        <include refid="columns"/>
        FROM tab_user
        <where>
            AND flag != 2
            <if test="searchFields.username != null and searchFields.username != ''">
                AND username = #{searchFields.username}
            </if>
            <if test="searchFields.realName != null and searchFields.realName != ''">
                AND realName = #{searchFields.realName}
            </if>
            <if test="searchFields.email != null and searchFields.email != ''">
                AND email = #{searchFields.email}
            </if>
            <if test="searchFields.mobile != null and searchFields.mobile != ''">
                AND mobile = #{searchFields.mobile}
            </if>
            <if test="searchFields.mobileArea != null and searchFields.mobileArea != ''">
                AND mobileArea = #{searchFields.mobileArea}
            </if>
            <if test="searchFields.gender != null and searchFields.gender != ''">
                AND gender = #{searchFields.gender}
            </if>
            <if test="searchFields.phone != null and searchFields.phone != ''">
                AND phone = #{searchFields.phone}
            </if>
            <if test="searchFields.address != null and searchFields.address != ''">
                AND address = #{searchFields.address}
            </if>
            <if test="searchFields.avatar != null and searchFields.avatar != ''">
                AND avatar is not null
            </if>
            <if test="searchFields.company != null and searchFields.company != ''">
                AND company = #{searchFields.company}
            </if>
            <if test="searchFields.licenseScan != null and searchFields.licenseScan != ''">
                AND licenseScan is not null
            </if>
            <if test="searchFields.userType != null and searchFields.userType != ''">
                AND userType = #{searchFields.userType}
            </if>
            <if test="searchFields.balance != null and searchFields.balance != ''">
                AND balance = #{searchFields.balance}
            </if>
            <if test="searchFields.createTime != null and searchFields.createTime != ''">
                AND createTime = #{searchFields.createTime}
            </if>
            <if test="searchFields.logintimes != null and searchFields.logintimes != ''">
                AND logintimes = #{searchFields.logintimes}
            </if>
        </where>
    </select>

    <!-- 不分页查询 -->
    <select id="searchPageByRecharge" resultMap="resultMap">
        SELECT id,max(username) as username,realName,cardType,cardNo,email,mobile,gender,qq,phone,createTime,modifyTime,userType,balance
        FROM tab_user
        <where>
            AND flag != 2
            <if test="searchFields.username != null and searchFields.username != ''">
                AND username = #{searchFields.username}
            </if>
            <if test="searchFields.eqAuthor != null and searchFields.eqAuthor != ''">
                AND id = #{searchFields.eqAuthor}
            </if>
            <if test="searchFields.notEqAuthor != null and searchFields.notEqAuthor != ''">
                AND id != #{searchFields.notEqAuthor}
            </if>
            <if test="searchFields.lessThanUserid != null">
                <![CDATA[AND id <= #{searchFields.lessThanUserid}]]>
            </if>
            <if test="searchFields.moreThanUserid != null">
                <![CDATA[AND id >= #{searchFields.moreThanUserid}]]>
            </if>
            <if test="searchFields.mobilePrefix != null and searchFields.mobilePrefix != ''">
                AND mobile like #{searchFields.mobilePrefix}
            </if>
            <if test="searchFields.startdate != null and searchFields.startdate != ''">
                AND date(createTime) >= #{searchFields.startdate}
            </if>
            <if test="searchFields.enddate != null and searchFields.enddate != ''">
                <![CDATA[AND date(createTime) <= #{searchFields.enddate}]]>
            </if>
            <if test="searchFields.gender != null and searchFields.gender != ''">
                AND gender = #{searchFields.gender}
            </if>
            <if test="searchFields.userType != null and searchFields.userType != ''">
                AND userType = #{searchFields.userType}
            </if>
        </where>
        GROUP BY username
    </select>

    <!-- 分页查询 -->
    <select id="searchPageByRechargePage" resultMap="resultMap">
        SELECT id,max(username) as username,realName,cardType,cardNo,email,mobile,gender,qq,phone,createTime,modifyTime,userType,balance
        FROM tab_user
        <where>
            AND flag != 2
            <if test="searchFields.username != null and searchFields.username != ''">
                AND username = #{searchFields.username}
            </if>
            <if test="searchFields.eqAuthor != null and searchFields.eqAuthor != ''">
                AND id = #{searchFields.eqAuthor}
            </if>
            <if test="searchFields.notEqAuthor != null and searchFields.notEqAuthor != ''">
                AND id != #{searchFields.notEqAuthor}
            </if>
            <if test="searchFields.lessThanUserid != null">
                <![CDATA[AND id <= #{searchFields.lessThanUserid}]]>
            </if>
            <if test="searchFields.moreThanUserid != null">
                <![CDATA[AND id >= #{searchFields.moreThanUserid}]]>
            </if>
            <if test="searchFields.mobilePrefix != null and searchFields.mobilePrefix != ''">
                AND mobile like #{searchFields.mobilePrefix}
            </if>
            <if test="searchFields.startdate != null and searchFields.startdate != ''">
                AND date(createTime) >= #{searchFields.startdate}
            </if>
            <if test="searchFields.enddate != null and searchFields.enddate != ''">
                <![CDATA[AND date(createTime) <= #{searchFields.enddate}]]>
            </if>
            <if test="searchFields.gender != null and searchFields.gender != ''">
                AND gender = #{searchFields.gender}
            </if>
            <if test="searchFields.userType != null and searchFields.userType != ''">
                AND userType = #{searchFields.userType}
            </if>
        </where>
        GROUP BY username
    </select>

    <!-- 新增 -->
    <insert id="insert" parameterType="User" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO tab_user (
        	username,
        	pwd,
        	pwdSalt,
        	payPwd,
        	payPwdSalt,
        	realName,
        	cardType,
        	cardNo,
        	email,
        	mobile,
        	mobileArea,
        	gender,
        	qq,
        	phone,
        	address,
        	zipcode,
        	avatar,
        	regip,
        	company,
        	licenseScan,
        	userType,
        	balance,
        	salt,
        	lastTime,
        	flag,
        	source,
        	logintimes,
        	remark,
        	createTime,
        	modifyTime,
        	openid,
        	prize,
        	lastPrizeTime,
        	warnBalance
		) VALUES (
        	#{username},
        	#{pwd},
        	#{pwdSalt},
        	#{payPwd},
        	#{payPwdSalt},
        	#{realName},
        	#{cardType},
        	#{cardNo},
        	#{email},
        	#{mobile},
        	#{mobileArea},
        	#{gender},
        	#{qq},
        	#{phone},
        	#{address},
        	#{zipcode},
        	#{avatar},
        	#{regip},
        	#{company},
        	#{licenseScan},
        	#{userType},
        	#{balance},
        	#{salt},
        	#{lastTime},
        	#{flag},
        	#{source},
        	#{logintimes},
        	#{remark},
        	#{createTime},
        	#{modifyTime},
        	#{openid},
        	#{prize},
        	#{lastPrizeTime},
        	#{warnBalance}
		)
	</insert>

    <!-- 更新密码 -->
    <update id="updatePwd">
        UPDATE tab_user
        <set>
            pwd = #{pwd},
            pwdSalt = #{pwdSalt},
            modifyTime = #{modifyTime}
        </set>
        WHERE
        id = #{id}
    </update>
    
      <!-- 更新密码 -->
    <update id="updatePayPwd">
        UPDATE tab_user
        <set>
            payPwd = #{payPwd},
            payPwdSalt = #{payPwdSalt},
            modifyTime = #{modifyTime}
        </set>
        WHERE
        id = #{id}
    </update>
    

    <!-- 更新 -->
    <update id="update">
        UPDATE tab_user
        <set>
            <if test="payPwd != null">
                payPwd = #{payPwd},
            </if>
            <if test="payPwdSalt != null">
                payPwdSalt = #{payPwdSalt},
            </if>
            <if test="realName != null">
                realName = #{realName},
            </if>
            <if test="cardType != null">
                cardType = #{cardType},
            </if>
            <if test="cardNo != null">
                cardNo = #{cardNo},
            </if>
            <if test="email != null">
                email = #{email},
            </if>
            <if test="mobile != null">
                mobile = #{mobile},
            </if>
            <if test="mobileArea != null">
                mobileArea = #{mobileArea},
            </if>
            <if test="gender != null">
                gender = #{gender},
            </if>
            <if test="qq != null">
                qq = #{qq},
            </if>
            <if test="phone != null">
                phone = #{phone},
            </if>
            <if test="address != null">
                address = #{address},
            </if>
            <if test="zipcode != null">
                zipcode = #{zipcode},
            </if>
            <if test="avatar != null">
                avatar = #{avatar},
            </if>
            <if test="regip != null">
                regip = #{regip},
            </if>
            <if test="company != null">
                company = #{company},
            </if>
            <if test="licenseScan != null">
                licenseScan = #{licenseScan},
            </if>
            <if test="userType != null">
                userType = #{userType},
            </if>
            <if test="salt != null">
                salt = #{salt},
            </if>
            <if test="lastTime != null">
                lastTime = #{lastTime},
            </if>
            <if test="flag != null">
                flag = #{flag},
            </if>
            <if test="source != null">
                source = #{source},
            </if>
            <if test="remark != null">
                remark = #{remark},
            </if>
            <if test="modifyTime != null">
                modifyTime = #{modifyTime},
            </if>
            <if test="openid != null">
                openid = #{openid},
            </if>
            <if test="prize != null">
                prize = #{prize},
            </if>
            <if test="lastPrizeTime != null">
                lastPrizeTime = #{lastPrizeTime},
            </if>
            <if test="warnBalance != null">
                warnBalance = #{warnBalance}
            </if>
        </set>
        WHERE
        id = #{id}
    </update>

    <!-- 更新用户余额 -->
    <update id="updateBalance">
        UPDATE tab_user
        <set>
            <if test="balance != null">
                balance = balance+#{balance}
            </if>
        </set>
        WHERE
        id = #{id}
    </update>
	
	<!-- 更新用户返奖余额 -->
    <update id="updateRewardBalance">
        UPDATE tab_user
        <set>
            <if test="prize != null">
                prize = prize+#{prize}
            </if>
        </set>
        WHERE
        id = #{id}
    </update>

    <!-- 更新用户余额，不累加 -->
    <update id="updateBalanceNoPlus">
        UPDATE tab_user
        <set>
            <if test="balance != null">
                balance = #{balance}
            </if>
        </set>
        WHERE
        id = #{id}
    </update>

    <!-- 更新用户登录次数 -->
    <update id="updateLogintimes">
        UPDATE tab_user
        <set>
            logintimes = logintimes+1
        </set>
        WHERE
        id = #{id}
    </update>

    <!-- 删除用户 -->
    <delete id="delete" parameterType="Long">
	     DELETE FROM tab_user WHERE id=#{id}
	</delete>
	<!-- 查询用户根据openid-->
    <select id="findUserByOpenid" resultType="User">
        SELECT max(id) as id ,
        username,
        pwd,
        pwdSalt,
        payPwd,payPwdSalt,
        realName,cardType,cardNo,
        email,mobile,mobileArea,gender,
        qq,phone,address,zipcode,avatar,regip,
        company,licenseScan,userType,balance,salt,
        lastTime,flag,source,logintimes,remark,createTime,modifyTime,openid,prize,lastPrizeTime
        FROM tab_user
        <where>
        	 <if test="openid != null and openid != ''">
                openid = #{openid}
            </if>
        </where>
    </select>

    <!-- 查询未完成彩票的发起人信息 -->
    <select id="searchUnfinishedOpenid" resultMap="resultMap">
        select tu.openid from tab_lottery_split tls,tab_user tu where tls.remainderCount !=0 and tls.marketid=#{marketid} and tu.id=tls.userid
    </select>
    
    <!-- ===========lingcai sdk======================== -->
     <!-- 更新用户余额预警 状态 -->
    <update id="updateWarnFlag">
        UPDATE tab_user
        <set>
            warnFlag = #{warnFlag}
        </set>
        WHERE
        id = #{id}
    </update>
</mapper> 
